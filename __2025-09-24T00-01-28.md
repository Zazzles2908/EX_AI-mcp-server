[ ] NAME:Current Task List DESCRIPTION:Root task for conversation __NEW_AGENT__
-[x] NAME:Beta Phase Execution Program (P0–P3 + RCA + Cleanup) DESCRIPTION:Execute implementation_roadmap (P0–P3), root_cause_analysis immediate fixes/tests, and system_cleanup_plan. Track end-to-end with EXAI‑WS validations and docs.
-[x] NAME:P0 — Dispatcher fallback wrapper for handle_call_tool DESCRIPTION:Add orchestrator wrapper mapping capability→fallback chains, per-attempt time budgets, JSONL breadcrumbs. Respect no-op circuit toggle.
-[x] NAME:P0 — Harden KimiMultiFileChatTool (retry + structured errors) DESCRIPTION:Ensure 1 retry with backoff; align timeout default (80→180s if safe); return structured envelopes on error; keep attachment-first.
-[x] NAME:P0 — Standardized error envelope helper DESCRIPTION:Create tiny helper used by tools to emit consistent failure envelopes (status,error_class,provider,model,tool,attempt,req_id).
-[x] NAME:P0 — Validation via EXAI‑WS only DESCRIPTION:Exercise kimi_multi_file_chat and representative tools with unpredictable prompts; verify breadcrumbs, no hangs, clear fallbacks.
-[x] NAME:P1 — Extend fallback to chat_with_tools and plain chat DESCRIPTION:Apply fallback pattern and optional websearch branches; unify timeout semantics across tools.
-[x] NAME:P1 — Circuit breakers (rolling window, cool-offs) DESCRIPTION:Implement per-provider breaker; record transitions in JSONL + activity logs; add half-open probes.
-[x] NAME:P1 — Tool unification for envelopes/timeouts DESCRIPTION:Normalize streaming vs non-streaming behavior; ensure consistent error semantics.
-[x] NAME:P1 — Stress validation DESCRIPTION:Randomized prompts/files; verify breakers route away from failing paths without user-visible errors.
-[x] NAME:P2 — Server modularization (create src/server modules) DESCRIPTION:Create orchestrator.py, dispatcher.py, fallback.py, circuit.py, telemetry.py, conversations.py, registry_bridge.py; thin server.py.
--[x] NAME:P2 — Telemetry/RegistryBridge touchpoints (no-op wiring) DESCRIPTION:Imports + init logs in server.py; telemetry DRY-RUN event in handle_call_tool; restart + validate.
-[x] NAME:P2 — Scripts reorg with wrappers + folder READMEs DESCRIPTION:Move scripts into canonical folders (validation, diagnostics, ws, e2e, tools, kimi_analysis, legacy); add wrappers + README per folder.
--[x] NAME:P2 — Add deprecation banners to top-level shim scripts DESCRIPTION:Add deprecation banner comments to shim scripts (ws_*, validate_quick, router_service_diagnostics_smoke, run_ws_daemon)
--[/] NAME:P2 — Batch 2: ws utilities move + restart + smoke DESCRIPTION:Confirm ws utilities canonical in scripts/ws, leave shims at top-level, restart daemon, validate via EXAI‑WS activity + chat.
--[x] NAME:P2 — Batch 3: Slim top-level wrappers to pure trampolines DESCRIPTION:Confirm wrappers function as trampolines; add banners; defer body deletions to later cleanup.
--[x] NAME:P2 — Batch 4: Diagnostics/validation canonicalization + validations DESCRIPTION:Verify canonical scripts in scripts/diagnostics & scripts/validation; ensure shims present; run EXAI-WS smoke.
-[x] NAME:P2 — Tool description/visibility cleanup DESCRIPTION:Remove manager-specific vocabulary; maintain visibility tiers (user, manager-only, backend).
-[x] NAME:P2 — Validation from new paths DESCRIPTION:Run ws/e2e scripts via wrappers; ensure no breakage.
-[x] NAME:P3 — Moonshot compliance (multi-turn, tools, file QA, context cache) DESCRIPTION:Align Kimi patterns: file-id attachments, tool-call schemas, context caching headers/tokens.
-[x] NAME:P3 — GLM native SDK migration DESCRIPTION:Adopt Zhipu native endpoints for web search, file upload, agent flows; minimal adapters keep MCP stable.
-[x] NAME:P3 — Optional MoonPalace diagnostic mode DESCRIPTION:Dev flag to route Kimi calls through MoonPalace; store artifacts under docs/augment_reports/augment_review_02/kimi_analysis/runs/.
-[ ] NAME:RCA — Standardize response envelopes module DESCRIPTION:Add tools/shared/response_envelope.py and migrate tools to use it.
-[ ] NAME:RCA — Response pipeline unit/integration tests DESCRIPTION:Add tests for serialization, normalization, fallback scenarios; verify no content loss.
--[x] NAME:P4 — Batch 5: Response pipeline tests + validations DESCRIPTION:Add minimal unit tests (no new deps) and integration validations for response pipeline per RCA. Produce markdown report with actual outputs and log excerpts.
--[x] NAME:P4 — Batch 5 — Unit tests: fallback_orchestrator._is_error_envelope DESCRIPTION:Create tests/test_fallback_orchestrator.py covering: empty list (False), success with content (False), success with empty content (False), explicit error status (True), plain text (False), error field (True).
--[x] NAME:P4 — Batch 5 — Integration: RESPONSE_DEBUG/VALIDATION log checks DESCRIPTION:Trigger GLM chat and Kimi multi-file chat with nonces; verify mcp_activity contains RESPONSE_DEBUG lines; record excerpts to report.
-[ ] NAME:Config — Simplify .env & migration script DESCRIPTION:Reduce to ~50 core vars; update .env.example with Moonshot base_url; add scripts/migrate_config.py; include deprecation banners.
--[ ] NAME:P4 — Batch 6: Config simplification (draft) DESCRIPTION:Create .env.simplified.example; add scripts/migrate_config.py (dry-run to .env.new); write report; do not change current .env.
-[ ] NAME:Tools — Consolidate to 12 core tools DESCRIPTION:Design new registry; implement smart_chat and file_chat; maintain backward-compatible wrappers.
--[ ] NAME:P4 — Batch 7: Tools consolidation (design + gated scaffold) DESCRIPTION:Write tools consolidation map; implement tools/smart/smart_chat.py advisory-only (ENABLE_SMART_CHAT=false by default); prepare file_chat wrapper; report.
-[ ] NAME:AI Manager — Implement manager and integrate routing DESCRIPTION:Create src/managers/ai_manager.py; wire into chat/smart tools; define routing decisions and prompt enhancement.
--[x] NAME:AI Manager — Advisory-only plan logging (landed) DESCRIPTION:Keep EX_AI_MANAGER_ENABLED=true and EX_AI_MANAGER_ADVISORY=true for visibility; ensure ai_manager_plan events emit; no routing changes.
--[ ] NAME:AI Manager — Operational routing proposal DESCRIPTION:Draft toggled routing design: when ENABLE_SMART_CHAT=true and EX_AI_MANAGER_ROUTE=true, apply suggested provider/model; otherwise advisory-only. Include rollback plan.
-[x] NAME:Docs/Diagrams — Decision-tree + architecture updates DESCRIPTION:Create decision-tree architecture markdown under docs/architecture; update diagrams; follow external_review guidance.
-[x] NAME:Validation reports — EXAI‑WS runs and logs DESCRIPTION:Run EXAI‑WS validations; append findings to docs/augment_reports/augment_review_02; ensure unpredictable prompts and real outputs.
-[x] NAME:P1 — Kimi provider path resolution hardening DESCRIPTION:Update KimiModelProvider.upload_file() to resolve relative paths against EX_PROJECT_ROOT → PROJECT_ROOT → CWD; add enriched diagnostics; prepare .env addition. Code implemented; pending validation after next restart.
-[ ] NAME:P4 — Batch 8: Native provider scaffolds (gated) DESCRIPTION:Add src/providers/zhipu_native.py and src/providers/moonshot_native.py scaffolds (not wired); verify imports; example calls; report.
-[ ] NAME:Final audit — Reconcile external_review docs vs implemented work DESCRIPTION:Audit implementation against implementation_roadmap, root_cause_analysis, immediate_fixes, system_cleanup_plan and internal tasks; produce reconciliation checklist and remaining gaps.
-[x] NAME:P5 Patch — Routing shim + fallback retry + restart + validate (no fixed outputs) DESCRIPTION:Implement AI-manager routing guard + argument shim for provider-specific → chat; add fallback primary retry with backoff; restart daemon; run GLM chat + Kimi multi-file chat validations; write report under docs/augment_reports/augment_review_02/.
-[/] NAME:Investigate EXAI‑WS wrapper Kimi timeouts DESCRIPTION:Diagnose wrapper-level early cancellations for kimi_multi_file_chat. Increase EXAI_WS_CALL_TIMEOUT if available, add progress heartbeat, and align wrapper timeouts with tool-level KIMI_MF_CHAT_TIMEOUT_SECS. Re-run validations and capture logs.