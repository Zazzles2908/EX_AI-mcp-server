## EXAI Live Audit (v5)

### Inputs (files)

- src\providers\openai_compatible.py

- src\providers\glm.py

- src\providers\kimi.py

- src\providers\custom.py

- src\providers\openrouter.py

- utils\http_client.py

- tools\glm_files.py


### Kimi audit

- Model: kimi-k2-0711-preview

- Response:


## Audit Summary â€“ GLM & Kimi Provider Changes

### ðŸ”´ Critical / High Priority
- **GLM `upload_file` silently falls back to HTTP**  
  When the SDK is available but `upload` fails, the exception is swallowed and the code continues to HTTP. This masks real SDK errors. Should raise or at least log the SDK failure before fallback.

- **GLM `upload_file` file handle leak**  
  In the HTTP fallback path the file handle is closed in a `finally` that may never run if `post_multipart` raises; use `with` context manager instead.

- **Kimi `generate_content` ignores `images` parameter**  
  The override calls `super().generate_content(...)` but never passes `images=images`; vision support is therefore broken for Kimi.

- **Kimi `upload_file` purpose mismatch**  
  The docstring says `purpose="file-extract"` but the actual call uses `purpose=purpose` which defaults to `"agent"` in the caller. Align docstring and default.

### ðŸŸ¡ Medium Priority
- **GLM `count_tokens` crude fallback**  
  Uses `len(text)//4` which is inaccurate for Chinese text; consider using the providerâ€™s tokenizer endpoint when available.

- **GLM `GLMMultiFileChatTool` uses placeholder system prompt**  
  Uploaded files are only listed by name; if GLM later exposes content retrieval the tool should fetch and inject real content (add TODO).

- **Kimi `_build_payload` duplicates vision logic**  
  Vision handling is already in `OpenAICompatibleProvider._process_image`; avoid re-implementing base64 encoding in Kimi.

- **Retry / timeout configs not propagated**  
  GLM HTTP client and Kimi `OpenAICompatibleProvider` use different timeout defaults; ensure both respect `CUSTOM_*_TIMEOUT` env vars.

### ðŸŸ¢ Low / Nice-to-have
- **Consistent provider instantiation**  
  Tools create provider instances ad-hoc; centralize via registry to share connection pools and retry policies.

- **Docstring drift**  
  Several parameter descriptions (`purpose`, `model`, `temperature`) differ between docstrings and actual defaults.

- **Type hints**  
  Add `-> str` return type to `upload_file` methods for clarity.

### Immediate Actions
1. Fix Kimi `generate_content` to forward `images=kwargs.get("images")`.  
2. Wrap GLM file handles in `with` blocks.  
3. Log SDK upload failure before HTTP fallback in GLM.  
4. Align Kimi `upload_file` default purpose to `"agent"` or update docstring.



### GLM audit

- Model: glm-4.5

- Uploaded files:

  - openai_compatible.py (id=1757402240601-b268b71df76b47e1aa6b643f488cd2a9.py)

  - glm.py (id=1757402240924-0a27950a78744a068dcb8d6d6c814d03.py)

  - kimi.py (id=1757402241241-b71140fbf965462a8f21170092f24263.py)

  - custom.py (id=1757402241542-16cc18472352473d8415e0a9e1822ee8.py)

  - openrouter.py (id=1757402241931-df9beb8f71c343b3a9550bebae316d56.py)

  - http_client.py (id=1757402242224-49097ca8717e415db459f965b329625a.py)

  - glm_files.py (id=1757402242514-5c65ac710f9a4edb8eda5e421d240617.py)

- Response:


# Code Review: Provider Integration Files

## High Priority Issues

* **Authentication Security**: API keys and credentials must be securely handled across all providers. Check for potential exposure in logs, error messages, or debugging outputs.
  
* **Error Handling Consistency**: Implement uniform error handling patterns across providers to ensure predictable behavior when APIs fail or return unexpected responses.

* **Retry Logic**: Add robust retry mechanisms with exponential backoff for transient failures, particularly for rate limiting and network issues.

* **Resource Management**: Ensure proper cleanup of resources, especially for streaming responses and file uploads, to prevent memory leaks and connection exhaustion.

## Medium Priority Issues

* **API Compliance**: Verify each provider implementation strictly adheres to their respective API specifications (GLM, Kimi/Moonshot, OpenRouter) to prevent unexpected behavior.

* **Streaming Implementation**: Ensure streaming is properly implemented with graceful error handling and resource cleanup to maintain responsiveness.

* **Rate Limiting**: Implement proper handling of rate limits with appropriate backoff strategies to maintain service availability.

* **Consistency**: Ensure a consistent interface and behavior across all provider implementations for ease of use and maintenance.

## Low Priority Issues

* **Documentation**: Add clear documentation for each provider implementation, especially for custom providers.

* **Logging**: Implement consistent logging that provides useful information without exposing sensitive data.

* **Testing**: Add comprehensive tests for each provider implementation, including error cases.

* **Configuration**: Ensure configuration options are clearly documented and have sensible defaults.

